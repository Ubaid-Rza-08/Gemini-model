<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KrishiMitra - Smart Crop Advisory System</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* Global Styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        :root {
            --primary: #2e7d32;
            --secondary: #7cb342;
            --accent: #ff9800;
            --light: #f5f9f5;
            --dark: #1b5e20;
            --text: #333;
            --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            --transition: all 0.3s ease;
        }
        
        body {
            background-color: #f8fdf8;
            color: var(--text);
            line-height: 1.6;
        }
        
        .container {
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }
        
        .btn {
            display: inline-block;
            background-color: var(--accent);
            color: white;
            padding: 12px 30px;
            border-radius: 30px;
            text-decoration: none;
            font-weight: 600;
            transition: var(--transition);
            border: none;
            cursor: pointer;
        }
        
        .btn:hover {
            background-color: #e65100;
            transform: translateY(-3px);
        }
        
        .btn:disabled {
            background-color: #ccc;
            cursor: not-allowed;
            transform: none;
        }
        
        .btn-primary {
            background-color: var(--primary);
        }
        
        .btn-primary:hover {
            background-color: var(--dark);
        }
        
        .section-title {
            text-align: center;
            margin-bottom: 50px;
            color: var(--primary);
        }
        
        .section-title h2 {
            font-size: 2.2rem;
            margin-bottom: 15px;
        }
        
        .section-title p {
            color: #666;
            max-width: 700px;
            margin: 0 auto;
        }
        
        /* Header Styles */
        header {
            background: linear-gradient(to right, var(--primary), var(--secondary));
            color: white;
            padding: 15px 0;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: var(--shadow);
        }
        
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .logo i {
            font-size: 2rem;
        }
        
        .logo h1 {
            font-size: 1.5rem;
            font-weight: 700;
        }
        
        nav ul {
            display: flex;
            list-style: none;
            gap: 25px;
        }
        
        nav a {
            color: white;
            text-decoration: none;
            font-weight: 500;
            transition: var(--transition);
        }
        
        nav a:hover {
            color: var(--accent);
        }
        
        .mobile-menu-btn {
            display: none;
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
        }
        
        /* Auth Overlay Styles */
        .auth-overlay {
            position: fixed;
            inset: 0;
            background: rgba(46, 125, 50, 0.95);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 3000;
        }
        
        .auth-form {
            background: white;
            padding: 40px;
            border-radius: 15px;
            width: 100%;
            max-width: 400px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            position: relative;
        }
        
        .auth-form h2 {
            text-align: center;
            margin-bottom: 30px;
            color: var(--primary);
            font-size: 1.8rem;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--text);
        }
        
        .form-group input, .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }
        
        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: var(--primary);
        }
        
        .auth-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        
        .auth-buttons .btn {
            flex: 1;
            text-align: center;
        }
        
        .auth-switch {
            text-align: center;
            margin-top: 20px;
            color: #666;
        }
        
        .auth-switch a {
            color: var(--primary);
            text-decoration: none;
            font-weight: 600;
        }
        
        .auth-switch a:hover {
            text-decoration: underline;
        }
        
        .error-message, .success-message {
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 15px;
            text-align: center;
        }
        
        .error-message {
            background-color: #ffebee;
            color: #d32f2f;
            border: 1px solid #ffcdd2;
        }
        
        .success-message {
            background-color: #e8f5e8;
            color: #2e7d32;
            border: 1px solid #c8e6c9;
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
            color: white;
        }
        
        .logout-btn {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 6px 12px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9rem;
        }
        
        .logout-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }
        
        /* Page Styles */
        .page {
            display: none;
            padding: 60px 0;
        }
        
        .page.active {
            display: block;
        }
        
        /* Hero Section */
        .hero {
            background: linear-gradient(rgba(0, 0, 0, 0.6), rgba(0, 0, 0, 0.6)), url('https://images.unsplash.com/photo-1625246336722-891c9e127978?ixlib=rb-4.0.3&auto=format&fit=crop&w=1200&q=80');
            background-size: cover;
            background-position: center;
            color: white;
            padding: 100px 0;
            text-align: center;
        }
        
        .hero-content {
            max-width: 800px;
            margin: 0 auto;
        }
        
        .hero h2 {
            font-size: 2.5rem;
            margin-bottom: 20px;
        }
        
        .hero p {
            font-size: 1.2rem;
            margin-bottom: 30px;
        }
        
        /* Features Section */
        .features {
            padding: 80px 0;
            background-color: white;
        }
        
        .features-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 30px;
        }
        
        .feature-card {
            background-color: var(--light);
            border-radius: 10px;
            padding: 30px;
            text-align: center;
            box-shadow: var(--shadow);
            transition: transform 0.3s ease;
        }
        
        .feature-card:hover {
            transform: translateY(-10px);
        }
        
        .feature-icon {
            background-color: var(--primary);
            color: white;
            width: 70px;
            height: 70px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 20px;
            font-size: 1.8rem;
        }
        
        .feature-card h3 {
            margin-bottom: 15px;
            color: var(--dark);
        }
        
        /* How It Works */
        .how-it-works {
            padding: 80px 0;
            background-color: #f0f7f0;
        }
        
        .steps {
            display: flex;
            justify-content: space-between;
            flex-wrap: wrap;
            margin-top: 50px;
        }
        
        .step {
            flex: 1;
            min-width: 250px;
            text-align: center;
            padding: 20px;
            position: relative;
        }
        
        .step-number {
            width: 50px;
            height: 50px;
            background-color: var(--secondary);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            font-weight: bold;
            margin: 0 auto 20px;
        }
        
        /* Advisory Tool */
        .advisory-tool {
            padding: 80px 0;
            background-color: white;
        }
        
        .tool-container {
            background-color: var(--light);
            border-radius: 10px;
            padding: 30px;
            box-shadow: var(--shadow);
            max-width: 800px;
            margin: 0 auto;
        }
        
        .result {
            margin-top: 30px;
            padding: 20px;
            background-color: white;
            border-radius: 5px;
            border-left: 4px solid var(--secondary);
            display: none;
        }
        
        .analysis-result {
            margin-top: 20px;
            padding: 20px;
            background: linear-gradient(135deg, #f0f7f0 0%, #e8f5e8 100%);
            border-radius: 10px;
            border-left: 4px solid var(--primary);
        }
        
        .analysis-result h4 {
            color: var(--primary);
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .fertilizer-card {
            background: white;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
            border: 1px solid #ddd;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            transition: all 0.3s ease;
        }
        
        .fertilizer-card:hover {
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            transform: translateY(-2px);
        }
        
        .fertilizer-card h6 {
            color: var(--dark);
            margin-bottom: 8px;
            font-size: 1.1rem;
        }
        
        .recommendation-section {
            margin: 15px 0;
        }
        
        .recommendation-section h5 {
            color: var(--primary);
            margin-bottom: 10px;
            font-size: 1rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .recommendation-section ul {
            list-style: none;
            padding-left: 0;
        }
        
        .recommendation-section ul li {
            padding: 8px 0;
            position: relative;
            padding-left: 25px;
            line-height: 1.5;
        }
        
        .recommendation-section ul li:before {
            content: "✓";
            position: absolute;
            left: 0;
            color: var(--primary);
            font-weight: bold;
        }
        
        .waiting-message {
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
            padding: 25px;
            border-radius: 12px;
            text-align: center;
            border-left: 5px solid #2196f3;
            margin: 20px 0;
            box-shadow: 0 4px 12px rgba(33, 150, 243, 0.1);
        }
        
        .processing-steps {
            display: flex;
            justify-content: space-around;
            margin: 20px 0;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .processing-step {
            background: white;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            flex: 1;
            min-width: 150px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }
        
        .processing-step i {
            font-size: 1.5rem;
            color: var(--primary);
            margin-bottom: 8px;
        }
        
        .pulse-animation {
            animation: pulse 1.5s ease-in-out infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        /* Testimonials */
        .testimonials {
            padding: 80px 0;
            background-color: #f0f7f0;
        }
        
        .testimonial-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 30px;
            margin-top: 50px;
        }
        
        .testimonial-card {
            background-color: white;
            border-radius: 10px;
            padding: 30px;
            box-shadow: var(--shadow);
        }
        
        .testimonial-text {
            font-style: italic;
            margin-bottom: 20px;
        }
        
        .testimonial-author {
            display: flex;
            align-items: center;
        }
        
        .author-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background-color: var(--primary);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            margin-right: 15px;
        }
        
        /* Chatbot Styles */
        .chat-message {
            margin-bottom: 20px;
            display: flex;
            align-items: flex-start;
        }
        
        .chat-message.user-message {
            flex-direction: row-reverse;
        }
        
        .message-content {
            max-width: 70%;
            padding: 12px 16px;
            border-radius: 18px;
            line-height: 1.4;
            word-wrap: break-word;
        }
        
        .bot-message .message-content {
            background-color: #f0f7f0;
            border-bottom-left-radius: 4px;
        }
        
        .user-message .message-content {
            background-color: var(--primary);
            color: white;
            border-bottom-right-radius: 4px;
        }
        
        .typing-indicator {
            display: none;
            padding: 12px 16px;
            background-color: #f0f7f0;
            border-radius: 18px;
            border-bottom-left-radius: 4px;
            margin-bottom: 15px;
            color: #666;
        }
        
        .typing-dots {
            display: inline-block;
        }
        
        .typing-dots:after {
            content: '';
            animation: dots 1.5s steps(5, end) infinite;
        }
        
        @keyframes dots {
            0%, 20% { content: '.'; }
            40% { content: '..'; }
            60% { content: '...'; }
            80%, 100% { content: ''; }
        }
        
        /* Floating Weather */
        #floating-weather {
            position: fixed;
            top: 70px;
            left: 10px;
            background-color: #549087;
            color: white;
            padding: 15px 20px;
            border-radius: 10px;
            box-shadow: var(--shadow);
            width: 180px;
            font-size: 0.9rem;
            z-index: 2000;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        #floating-weather:hover {
            background-color: var(--secondary);
        }

        #floating-weather h4 {
            margin-top: 10px;
            font-size: 1.1rem;
            text-align: center;
        }

        #floating-weather-content p {
            margin: 5px 0;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        /* Footer */
        footer {
            background-color: var(--dark);
            color: white;
            padding: 50px 0 20px;
        }
        
        .footer-content {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 40px;
            margin-bottom: 30px;
        }
        
        .footer-column h3 {
            margin-bottom: 20px;
            font-size: 1.2rem;
        }
        
        .footer-column ul {
            list-style: none;
        }
        
        .footer-column ul li {
            margin-bottom: 10px;
        }
        
        .footer-column a {
            color: #ccc;
            text-decoration: none;
            transition: color 0.3s ease;
        }
        
        .footer-column a:hover {
            color: white;
        }
        
        .social-links {
            display: flex;
            gap: 15px;
            margin-top: 20px;
        }
        
        .social-links a {
            display: inline-block;
            width: 40px;
            height: 40px;
            background-color: rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }
        
        .social-links a:hover {
            background-color: var(--accent);
            transform: translateY(-3px);
        }
        
        .copyright {
            text-align: center;
            padding-top: 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            font-size: 0.9rem;
            color: #ccc;
        }
        
        /* Responsive Design */
        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                text-align: center;
                gap: 15px;
            }
            
            nav ul {
                flex-direction: column;
                gap: 10px;
            }
            
            .hero h2 {
                font-size: 2rem;
            }
            
            .steps {
                flex-direction: column;
                gap: 40px;
            }
            
            .mobile-menu-btn {
                display: block;
                position: absolute;
                top: 15px;
                right: 20px;
            }
            
            .nav-menu {
                display: none;
            }
            
            .nav-menu.active {
                display: block;
            }
            
            .auth-form {
                margin: 20px;
                padding: 30px 20px;
            }
            
            .processing-steps {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <!-- Authentication Overlay -->
    <div id="auth-overlay" class="auth-overlay" style="display: flex;">
        <!-- Login Form -->
        <div id="login-form" class="auth-form">
            <h2>Welcome to KrishiMitra</h2>
            <div id="auth-message"></div>
            
            <div class="form-group">
                <label for="login-phone">Phone Number</label>
                <input type="tel" id="login-phone" placeholder="+91XXXXXXXXXX" required>
            </div>
            
            <div class="auth-buttons">
                <button type="button" class="btn btn-primary" onclick="sendOtp()">Send OTP</button>
            </div>
            
            <div class="auth-switch">
                Don't have an account? <a href="#" onclick="showSignupForm()">Sign Up</a>
            </div>
        </div>
        
        <!-- Signup Form -->
        <div id="signup-form" class="auth-form" style="display: none;">
            <h2>Join KrishiMitra</h2>
            <div id="signup-message"></div>
            
            <div class="form-group">
                <label for="signup-name">Full Name</label>
                <input type="text" id="signup-name" placeholder="Enter your full name" required>
            </div>
            
            <div class="form-group">
                <label for="signup-phone">Phone Number</label>
                <input type="tel" id="signup-phone" placeholder="+91XXXXXXXXXX" required>
            </div>
            
            <div class="form-group">
                <label for="signup-city">City</label>
                <input type="text" id="signup-city" placeholder="Enter your city" required>
            </div>
            
            <div class="form-group">
                <label for="signup-area">Area/Village</label>
                <input type="text" id="signup-area" placeholder="Enter your area">
            </div>
            
            <div class="form-group">
                <label for="signup-local">Local Address</label>
                <input type="text" id="signup-local" placeholder="Enter local address">
            </div>
            
            <div class="auth-buttons">
                <button type="button" class="btn btn-primary" onclick="signup()">Sign Up</button>
            </div>
            
            <div class="auth-switch">
                Already have an account? <a href="#" onclick="showLoginForm()">Login</a>
            </div>
        </div>
        
        <!-- OTP Verification Form -->
        <div id="otp-form" class="auth-form" style="display: none;">
            <h2>Verify OTP</h2>
            <div id="otp-message"></div>
            
            <p style="text-align: center; margin-bottom: 20px; color: #666;">
                We've sent a 6-digit code to <span id="otp-phone-display"></span>
            </p>
            
            <div class="form-group">
                <label for="otp-code">Enter OTP</label>
                <input type="text" id="otp-code" placeholder="Enter 6-digit code" maxlength="6" required>
            </div>
            
            <div class="auth-buttons">
                <button type="button" class="btn btn-primary" onclick="verifyOtp()">Verify OTP</button>
            </div>
            
            <div class="auth-switch">
                <a href="#" onclick="resendOtp()">Resend OTP</a> | 
                <a href="#" onclick="showLoginForm()">Back to Login</a>
            </div>
        </div>
    </div>

    <!-- Header -->
    <header>
        <div class="container">
            <div class="header-content">
                <div class="logo">
                    <i class="fas fa-seedling"></i>
                    <h1>KrishiMitra</h1>
                </div>
                <button class="mobile-menu-btn">
                    <i class="fas fa-bars"></i>
                </button>
                <nav class="nav-menu">
                    <ul>
                        <li><a href="#" class="nav-link" data-page="home">Home</a></li>
                        <li><a href="#" class="nav-link" data-page="advisory">Crop Advisory</a></li>
                        <li><a href="#" class="nav-link" data-page="chatbot">AI Chatbot</a></li>
                        <li><a href="#" class="nav-link" data-page="market">Market Prices</a></li>
                        <li><a href="#" class="nav-link" data-page="resources">Resources</a></li>
                        <li><a href="#" class="nav-link" data-page="weather">Weather</a></li>
                        <div class="user-info" id="user-info" style="display: none;">
                            <span id="user-name"></span>
                            <button class="logout-btn" onclick="logout()">Logout</button>
                        </div>
                    </ul>
                </nav>
            </div>
        </div>
    </header>
    
    <!-- Home Page -->
    <section id="home" class="page active">
        <!-- Hero Section -->
        <div class="hero">
            <div class="container">
                <div class="hero-content">
                    <h2>Smart Crop Advisory for Small & Marginal Farmers</h2>
                    <p>Get personalized, AI-powered advice for your crops. Increase yields, reduce costs, and farm smarter with our expert guidance.</p>
                    <a href="#" class="btn nav-link" data-page="advisory">Get Free Advice</a>
                </div>
            </div>
        </div>

        <!-- Features Section -->
        <div class="features">
            <div class="container">
                <div class="section-title">
                    <h2>How We Help Farmers</h2>
                    <p>Our smart advisory system provides actionable insights tailored to your specific farming conditions</p>
                </div>
                <div class="features-grid">
                    <div class="feature-card">
                        <div class="feature-icon">
                            <i class="fas fa-cloud-sun"></i>
                        </div>
                        <h3>Weather Alerts</h3>
                        <p>Get precise weather forecasts and alerts for your specific location to protect your crops.</p>
                    </div>
                    <div class="feature-card">
                        <div class="feature-icon">
                            <i class="fas fa-bug"></i>
                        </div>
                        <h3>Pest Management</h3>
                        <p>Identify and manage pests and diseases with eco-friendly solutions.</p>
                    </div>
                    <div class="feature-card">
                        <div class="feature-icon">
                            <i class="fas fa-tint"></i>
                        </div>
                        <h3>Irrigation Advice</h3>
                        <p>Optimize water usage with smart irrigation recommendations.</p>
                    </div>
                    <div class="feature-card">
                        <div class="feature-icon">
                            <i class="fas fa-chart-line"></i>
                        </div>
                        <h3>Yield Prediction</h3>
                        <p>Accurate yield forecasts to help you plan harvest and sales.</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- How It Works -->
        <div class="how-it-works">
            <div class="container">
                <div class="section-title">
                    <h2>How It Works</h2>
                    <p>Getting personalized crop advice is simple with our system</p>
                </div>
                <div class="steps">
                    <div class="step">
                        <div class="step-number">1</div>
                        <h3>Share Your Details</h3>
                        <p>Tell us about your crops, location, and soil type</p>
                    </div>
                    <div class="step">
                        <div class="step-number">2</div>
                        <h3>We Analyze</h3>
                        <p>Our system processes your data with weather and market information</p>
                    </div>
                    <div class="step">
                        <div class="step-number">3</div>
                        <h3>Get Recommendations</h3>
                        <p>Receive actionable advice on your phone via SMS or app</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Testimonials -->
        <div class="testimonials">
            <div class="container">
                <div class="section-title">
                    <h2>Success Stories</h2>
                    <p>Hear from farmers who have benefited from our advisory system</p>
                </div>
                <div class="testimonial-grid">
                    <div class="testimonial-card">
                        <div class="testimonial-text">
                            "The pest management advice saved my cotton crop from whitefly infestation. I was able to take action before it was too late."
                        </div>
                        <div class="testimonial-author">
                            <div class="author-avatar">
                                <i class="fas fa-user"></i>
                            </div>
                            <div>
                                <h4>Rajesh Kumar</h4>
                                <p>Cotton Farmer, Maharashtra</p>
                            </div>
                        </div>
                    </div>
                    <div class="testimonial-card">
                        <div class="testimonial-text">
                            "The irrigation advice helped me reduce water usage by 30% while maintaining my yield. This saved me money and helped the environment."
                        </div>
                        <div class="testimonial-author">
                            <div class="author-avatar">
                                <i class="fas fa-user"></i>
                            </div>
                            <div>
                                <h4>Priya Singh</h4>
                                <p>Rice Farmer, Punjab</p>
                            </div>
                        </div>
                    </div>
                    <div class="testimonial-card">
                        <div class="testimonial-text">
                            "The weather alerts warned me about unexpected rains, allowing me to harvest my wheat crop just in time. Saved me from major losses."
                        </div>
                        <div class="testimonial-author">
                            <div class="author-avatar">
                                <i class="fas fa-user"></i>
                            </div>
                            <div>
                                <h4>Amir Khan</h4>
                                <p>Wheat Farmer, Uttar Pradesh</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Crop Advisory Page -->
    <section id="advisory" class="page">
        <div class="container">
            <div class="section-title">
                <h2>AI Soil Analysis & Crop Advisory</h2>
                <p>Get AI-powered soil analysis and fertilizer recommendations for your crops</p>
            </div>
            <div class="tool-container">
                <form id="advisory-form" enctype="multipart/form-data">
                    <div class="form-group">
                        <label for="crop-type">Crop Type *</label>
                        <select id="crop-type" required>
                            <option value="">Select Crop</option>
                            <option value="wheat">Wheat</option>
                            <option value="rice">Rice</option>
                            <option value="corn">Corn</option>
                            <option value="sugarcane">Sugarcane</option>
                            <option value="cotton">Cotton</option>
                            <option value="potato">Potato</option>
                            <option value="tomato">Tomato</option>
                            <option value="onion">Onion</option>
                            <option value="soybean">Soybean</option>
                            <option value="groundnut">Groundnut</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="area-value">Farm Area *</label>
                        <input type="number" id="area-value" placeholder="Enter area value" step="0.1" min="0.1" required>
                    </div>
                    <div class="form-group">
                        <label for="area-unit">Area Unit *</label>
                        <select id="area-unit" required>
                            <option value="">Select Unit</option>
                            <option value="ACRE">Acre</option>
                            <option value="BIGHA">Bigha</option>
                            <option value="HECTARE">Hectare</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="season">Season *</label>
                        <select id="season" required>
                            <option value="">Select Season</option>
                            <option value="KHARIF">Kharif (Monsoon)</option>
                            <option value="RABI">Rabi (Winter)</option>
                            <option value="SUMMER">Summer</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="language">Language *</label>
                        <select id="language" required>
                            <option value="">Select Language</option>
                            <option value="en">English</option>
                            <option value="hi">Hindi</option>
                            <option value="bn">Bengali</option>
                            <option value="te">Telugu</option>
                            <option value="ta">Tamil</option>
                            <option value="gu">Gujarati</option>
                            <option value="mr">Marathi</option>
                            <option value="kn">Kannada</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="location">Location (Optional)</label>
                        <input type="text" id="location" placeholder="Enter your location">
                    </div>
                    <div class="form-group">
                        <label for="soil-type-select">Soil Type (Optional)</label>
                        <select id="soil-type-select">
                            <option value="">Select Soil Type (or upload image)</option>
                            <option value="CLAY">Clay</option>
                            <option value="SANDY">Sandy</option>
                            <option value="LOAMY">Loamy</option>
                            <option value="SILT">Silt</option>
                            <option value="RED_SOIL">Red Soil</option>
                            <option value="BLACK_SOIL">Black Soil</option>
                            <option value="ALLUVIAL">Alluvial</option>
                            <option value="LATERITE">Laterite</option>
                            <option value="MOUNTAIN_SOIL">Mountain Soil</option>
                            <option value="DESERT_SOIL">Desert Soil</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="soil-image">Soil Image (Optional)</label>
                        <input type="file" id="soil-image" accept="image/jpeg,image/jpg,image/png,image/webp">
                        <small style="color: #666; display: block; margin-top: 5px;">
                            Upload a clear image of your soil for AI analysis (max 5MB)
                        </small>
                    </div>
                    <button type="submit" class="btn" id="submit-btn">Get AI Soil Analysis</button>
                </form>
                
                <div class="result" id="result">
                    <h3>AI Soil Analysis & Fertilizer Recommendations</h3>
                    <div id="advice-content"></div>
                </div>
            </div>
        </div>
    </section>

    <!-- Chatbot Page -->
    <section id="chatbot" class="page">
        <div class="container">
            <div class="section-title">
                <h2>AI Agriculture Assistant</h2>
                <p>Chat with our AI expert for instant farming advice and solutions</p>
            </div>
            <div class="tool-container" style="max-width: 900px;">
                <div id="chat-container" style="background: white; border-radius: 10px; height: 500px; display: flex; flex-direction: column;">
                    <!-- Chat Messages Area -->
                    <div id="chat-messages" style="flex: 1; padding: 20px; overflow-y: auto; border-bottom: 2px solid #f0f7f0;">
                        <div class="chat-message bot-message">
                            <div class="message-content">
                                <i class="fas fa-robot" style="color: var(--primary); margin-right: 8px;"></i>
                                Hello! I'm your AI agriculture assistant. Ask me about crops, soil, fertilizers, pest control, or any farming-related questions. I can also analyze images of your plants or soil!
                            </div>
                        </div>
                    </div>
                    
                    <!-- Chat Input Area -->
                    <div style="padding: 20px;">
                        <form id="chat-form" style="display: flex; gap: 10px; align-items: end;">
                            <div style="flex: 1;">
                                <input type="text" id="chat-input" placeholder="Ask about farming, crops, soil, fertilizers..." 
                                       style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 1rem;">
                                <input type="file" id="chat-image" accept="image/jpeg,image/jpg,image/png,image/webp" 
                                       style="margin-top: 5px; font-size: 0.9rem;">
                            </div>
                            <button type="submit" class="btn" style="margin: 0;">
                                <i class="fas fa-paper-plane"></i> Send
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Weather Page -->
    <section id="weather" class="page">
        <div class="container">
            <div class="section-title">
                <h2>Weather Information</h2>
                <p>Get accurate weather data for your location</p>
            </div>
            <div class="tool-container">
                <form id="weather-form">
                    <div class="form-group">
                        <label for="city">City Name</label>
                        <input type="text" id="weather-city" placeholder="Enter city name" required>
                    </div>
                    <button type="submit" class="btn">Get Weather</button>
                </form>
                <div class="result" id="weather-result">
                    <h3>Weather Information</h3>
                    <div id="weather-data"></div>
                </div>
            </div>
        </div>
    </section>

    <!-- Market Prices Page -->
    <section id="market" class="page">
        <div class="container">
            <div class="section-title">
                <h2>Market Prices</h2>
                <p>Latest commodity prices in your region</p>
            </div>
            <div class="tool-container">
                <table style="width: 100%; border-collapse: collapse; margin-top: 20px;">
                    <thead>
                        <tr style="background-color: var(--primary); color: white;">
                            <th style="padding: 12px; text-align: left;">Crop</th>
                            <th style="padding: 12px; text-align: left;">Price (₹/kg)</th>
                            <th style="padding: 12px; text-align: left;">Market</th>
                            <th style="padding: 12px; text-align: left;">Trend</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr style="border-bottom: 1px solid #ddd;">
                            <td style="padding: 12px;">Wheat</td>
                            <td style="padding: 12px;">24.50</td>
                            <td style="padding: 12px;">Delhi Mandi</td>
                            <td style="padding: 12px; color: green;">↑ 2%</td>
                        </tr>
                        <tr style="border-bottom: 1px solid #ddd;">
                            <td style="padding: 12px;">Rice</td>
                            <td style="padding: 12px;">32.75</td>
                            <td style="padding: 12px;">Kolkata Mandi</td>
                            <td style="padding: 12px; color: red;">↓ 1.5%</td>
                        </tr>
                        <tr style="border-bottom: 1px solid #ddd;">
                            <td style="padding: 12px;">Cotton</td>
                            <td style="padding: 12px;">68.20</td>
                            <td style="padding: 12px;">Mumbai Market</td>
                            <td style="padding: 12px; color: green;">↑ 3.2%</td>
                        </tr>
                        <tr style="border-bottom: 1px solid #ddd;">
                            <td style="padding: 12px;">Sugarcane</td>
                            <td style="padding: 12px;">3.45</td>
                            <td style="padding: 12px;">UP Market</td>
                            <td style="padding: 12px; color: orange;">→ Stable</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </section>

    <!-- Resources Page -->
    <section id="resources" class="page">
        <div class="container">
            <div class="section-title">
                <h2>Farming Resources</h2>
                <p>Educational materials and guides for better farming practices</p>
            </div>
            <div class="features-grid">
                <div class="feature-card">
                    <div class="feature-icon">
                        <i class="fas fa-book"></i>
                    </div>
                    <h3>Crop Guides</h3>
                    <p>Detailed guides for growing various crops in different conditions</p>
                    <a href="#" class="btn" style="margin-top: 15px;">Download</a>
                </div>
                <div class="feature-card">
                    <div class="feature-icon">
                        <i class="fas fa-video"></i>
                    </div>
                    <h3>Video Tutorials</h3>
                    <p>Step-by-step videos on modern farming techniques</p>
                    <a href="#" class="btn" style="margin-top: 15px;">Watch</a>
                </div>
                <div class="feature-card">
                    <div class="feature-icon">
                        <i class="fas fa-calendar-alt"></i>
                    </div>
                    <h3>Farming Calendar</h3>
                    <p>Optimal timing for planting and harvesting different crops</p>
                    <a href="#" class="btn" style="margin-top: 15px;">View</a>
                </div>
                <div class="feature-card">
                    <div class="feature-icon">
                        <i class="fas fa-phone-alt"></i>
                    </div>
                    <h3>Expert Help</h3>
                    <p>Connect with agricultural experts for personalized guidance</p>
                    <a href="#" class="btn" style="margin-top: 15px;">Contact</a>
                </div>
            </div>
        </div>
    </section>

    <!-- Footer -->
    <footer>
        <div class="container">
            <div class="footer-content">
                <div class="footer-column">
                    <h3>KrishiMitra</h3>
                    <p>Empowering small and marginal farmers with smart crop advisory services for sustainable agriculture.</p>
                    <div class="social-links">
                        <a href="#"><i class="fab fa-facebook-f"></i></a>
                        <a href="#"><i class="fab fa-twitter"></i></a>
                        <a href="#"><i class="fab fa-instagram"></i></a>
                        <a href="#"><i class="fab fa-youtube"></i></a>
                    </div>
                </div>
                <div class="footer-column">
                    <h3>Quick Links</h3>
                    <ul>
                        <li><a href="#" class="nav-link" data-page="home">Home</a></li>
                        <li><a href="#" class="nav-link" data-page="advisory">Crop Advisory</a></li>
                        <li><a href="#" class="nav-link" data-page="chatbot">AI Chatbot</a></li>
                        <li><a href="#" class="nav-link" data-page="weather">Weather</a></li>
                        <li><a href="#" class="nav-link" data-page="market">Market Prices</a></li>
                    </ul>
                </div>
                <div class="footer-column">
                    <h3>Contact Us</h3>
                    <ul>
                        <li><i class="fas fa-phone"></i> +91 9876543210</li>
                        <li><i class="fas fa-envelope"></i> info@krishimitra.com</li>
                        <li><i class="fas fa-map-marker-alt"></i> Agriculture Center, New Delhi</li>
                    </ul>
                </div>
            </div>
            <div class="copyright">
                <p>&copy; 2023 KrishiMitra. All rights reserved.</p>
            </div>
        </div>
    </footer>

    <!-- Floating Weather Widget -->
    <div id="floating-weather" aria-label="Floating Weather Report" role="region" tabindex="0">
        <h4>Current Weather</h4>
        <div id="floating-weather-content">
            <p><i class="fas fa-temperature-high"></i> Loading...</p>
            <p><i class="fas fa-cloud-rain"></i> Loading...</p>
            <p><i class="fas fa-wind"></i> Loading...</p>
        </div>
    </div>

    <script>
        // Configuration
        const API_BASE_URL = 'http://localhost:8080/api/v1'; // Adjust to your backend URL
        const SOIL_ANALYSIS_URL = 'http://localhost:8081/api/producer/soil-analysis-form';
        const FERTILIZER_ANALYSIS_URL = 'http://localhost:8082/api/fertilizer/analyze';
        const CHATBOT_URL = 'http://localhost:8082/api/agriculture/chat';
        
        // State management
        let currentUser = null;
        let accessToken = null;
        let refreshToken = null;
        let currentPhone = null;
        let chatSessionId = null;

        // DOM elements
        const authOverlay = document.getElementById('auth-overlay');
        const loginForm = document.getElementById('login-form');
        const signupForm = document.getElementById('signup-form');
        const otpForm = document.getElementById('otp-form');
        const userInfo = document.getElementById('user-info');

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            // Check if user is already logged in
            checkExistingAuth();
            
            // Initialize navigation
            initializeNavigation();
            
            // Initialize forms
            initializeForms();
            
            // Initialize weather widget
            initializeWeatherWidget();
        });

        // Authentication functions
        function checkExistingAuth() {
            const storedAccessToken = localStorage.getItem('accessToken');
            const storedRefreshToken = localStorage.getItem('refreshToken');
            const storedUser = localStorage.getItem('currentUser');

            if (storedAccessToken && storedRefreshToken && storedUser) {
                accessToken = storedAccessToken;
                refreshToken = storedRefreshToken;
                currentUser = JSON.parse(storedUser);
                
                // Hide auth overlay and show user info
                authOverlay.style.display = 'none';
                showUserInfo();
            }
        }

        function showUserInfo() {
            if (currentUser) {
                document.getElementById('user-name').textContent = `Welcome, ${currentUser.name || 'User'}`;
                userInfo.style.display = 'flex';
            }
        }

        function showMessage(elementId, message, type = 'error') {
            const element = document.getElementById(elementId);
            element.innerHTML = `<div class="${type}-message">${message}</div>`;
        }

        function clearMessage(elementId) {
            document.getElementById(elementId).innerHTML = '';
        }

        // Form switching functions
        function showLoginForm() {
            loginForm.style.display = 'block';
            signupForm.style.display = 'none';
            otpForm.style.display = 'none';
            clearMessage('auth-message');
            clearMessage('signup-message');
            clearMessage('otp-message');
        }

        function showSignupForm() {
            loginForm.style.display = 'none';
            signupForm.style.display = 'block';
            otpForm.style.display = 'none';
            clearMessage('auth-message');
            clearMessage('signup-message');
            clearMessage('otp-message');
        }

        function showOtpForm(phone) {
            loginForm.style.display = 'none';
            signupForm.style.display = 'none';
            otpForm.style.display = 'block';
            document.getElementById('otp-phone-display').textContent = phone;
            currentPhone = phone;
            clearMessage('auth-message');
            clearMessage('signup-message');
            clearMessage('otp-message');
        }

        // API functions
        async function signup() {
            const name = document.getElementById('signup-name').value.trim();
            const phone = document.getElementById('signup-phone').value.trim();
            const city = document.getElementById('signup-city').value.trim();
            const area = document.getElementById('signup-area').value.trim();
            const local = document.getElementById('signup-local').value.trim();

            if (!name || !phone || !city) {
                showMessage('signup-message', 'Please fill in all required fields');
                return;
            }

            try {
                const response = await fetch(`${API_BASE_URL}/auth/signup`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        name: name,
                        phone: phone,
                        city: city,
                        area: area,
                        local: local
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    showMessage('signup-message', 'Account created successfully! You can now login.', 'success');
                    setTimeout(() => {
                        showLoginForm();
                        document.getElementById('login-phone').value = phone;
                    }, 2000);
                } else {
                    showMessage('signup-message', data.message || 'Signup failed');
                }
            } catch (error) {
                showMessage('signup-message', 'Network error. Please try again.');
                console.error('Signup error:', error);
            }
        }

        async function sendOtp() {
            const phone = document.getElementById('login-phone').value.trim();

            if (!phone) {
                showMessage('auth-message', 'Please enter phone number');
                return;
            }

            try {
                const response = await fetch(`${API_BASE_URL}/auth/send-otp`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ phone: phone })
                });

                const data = await response.json();

                if (response.ok) {
                    showMessage('auth-message', 'OTP sent successfully!', 'success');
                    setTimeout(() => {
                        showOtpForm(phone);
                    }, 1500);
                } else {
                    showMessage('auth-message', data.message || 'Failed to send OTP');
                }
            } catch (error) {
                showMessage('auth-message', 'Network error. Please try again.');
                console.error('Send OTP error:', error);
            }
        }

        async function verifyOtp() {
            const otp = document.getElementById('otp-code').value.trim();

            if (!otp || otp.length !== 6) {
                showMessage('otp-message', 'Please enter valid 6-digit OTP');
                return;
            }

            try {
                const response = await fetch(`${API_BASE_URL}/auth/verify-otp`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        phone: currentPhone,
                        otp: otp
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    // Store tokens and user data
                    accessToken = data.accessToken;
                    refreshToken = data.refreshToken;
                    currentUser = { userId: data.userId, phone: currentPhone };

                    localStorage.setItem('accessToken', accessToken);
                    localStorage.setItem('refreshToken', refreshToken);
                    localStorage.setItem('currentUser', JSON.stringify(currentUser));

                    showMessage('otp-message', 'Login successful!', 'success');
                    
                    setTimeout(() => {
                        authOverlay.style.display = 'none';
                        showUserInfo();
                        loadUserWeather();
                    }, 1500);
                } else {
                    showMessage('otp-message', data.message || 'Invalid OTP');
                }
            } catch (error) {
                showMessage('otp-message', 'Network error. Please try again.');
                console.error('Verify OTP error:', error);
            }
        }

        async function resendOtp() {
            if (!currentPhone) {
                showMessage('otp-message', 'Phone number not found');
                return;
            }

            try {
                const response = await fetch(`${API_BASE_URL}/auth/send-otp`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ phone: currentPhone })
                });

                const data = await response.json();

                if (response.ok) {
                    showMessage('otp-message', 'OTP resent successfully!', 'success');
                } else {
                    showMessage('otp-message', data.message || 'Failed to resend OTP');
                }
            } catch (error) {
                showMessage('otp-message', 'Network error. Please try again.');
                console.error('Resend OTP error:', error);
            }
        }

        async function refreshAccessToken() {
            try {
                const response = await fetch(`${API_BASE_URL}/auth/refresh`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ refreshToken: refreshToken })
                });

                const data = await response.json();

                if (response.ok) {
                    accessToken = data.accessToken;
                    refreshToken = data.refreshToken;
                    
                    localStorage.setItem('accessToken', accessToken);
                    localStorage.setItem('refreshToken', refreshToken);
                    
                    return true;
                } else {
                    logout();
                    return false;
                }
            } catch (error) {
                console.error('Refresh token error:', error);
                logout();
                return false;
            }
        }

        function logout() {
            accessToken = null;
            refreshToken = null;
            currentUser = null;
            currentPhone = null;

            localStorage.removeItem('accessToken');
            localStorage.removeItem('refreshToken');
            localStorage.removeItem('currentUser');

            userInfo.style.display = 'none';
            authOverlay.style.display = 'flex';
            showLoginForm();
        }

        // Weather functions
        async function loadUserWeather() {
            if (!accessToken || !currentUser) return;

            try {
                const response = await apiCall(`${API_BASE_URL}/location?city=Delhi`);
                if (response) {
                    updateFloatingWeather(JSON.parse(response));
                }
            } catch (error) {
                console.error('Weather load error:', error);
            }
        }

        async function getWeatherForCity(city) {
            if (!accessToken) {
                alert('Please login to access weather information');
                return;
            }

            try {
                const response = await apiCall(`${API_BASE_URL}/location?city=${encodeURIComponent(city)}`);
                if (response) {
                    const weatherData = JSON.parse(response);
                    displayWeatherData(weatherData);
                }
            } catch (error) {
                console.error('Weather API error:', error);
                document.getElementById('weather-data').innerHTML = '<p>Failed to load weather data</p>';
            }
        }

        function displayWeatherData(data) {
            const weatherDiv = document.getElementById('weather-data');
            const resultDiv = document.getElementById('weather-result');
            
            if (data && data.weather && data.weather[0]) {
                const weather = data.weather[0];
                const main = data.main;
                weatherDiv.innerHTML = `
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-top: 20px;">
                        <div style="background: #f0f7f0; padding: 20px; border-radius: 8px;">
                            <h4>Temperature</h4>
                            <p style="font-size: 1.5rem; color: var(--primary);">${Math.round(main.temp - 273.15)}°C</p>
                            <p>Feels like ${Math.round(main.feels_like - 273.15)}°C</p>
                        </div>
                        <div style="background: #f0f7f0; padding: 20px; border-radius: 8px;">
                            <h4>Conditions</h4>
                            <p style="font-size: 1.2rem; color: var(--primary);">${weather.main}</p>
                            <p>${weather.description}</p>
                        </div>
                        <div style="background: #f0f7f0; padding: 20px; border-radius: 8px;">
                            <h4>Humidity</h4>
                            <p style="font-size: 1.5rem; color: var(--primary);">${main.humidity}%</p>
                        </div>
                        <div style="background: #f0f7f0; padding: 20px; border-radius: 8px;">
                            <h4>Pressure</h4>
                            <p style="font-size: 1.5rem; color: var(--primary);">${main.pressure} hPa</p>
                        </div>
                    </div>
                `;
            } else {
                weatherDiv.innerHTML = '<p>Weather data not available</p>';
            }
            
            resultDiv.style.display = 'block';
            resultDiv.scrollIntoView({ behavior: 'smooth' });
        }

        function updateFloatingWeather(data) {
            if (!data || !data.main || !data.weather) return;

            const container = document.getElementById('floating-weather-content');
            const temp = Math.round(data.main.temp - 273.15);
            const humidity = data.main.humidity;
            const condition = data.weather[0].main;

            container.innerHTML = `
                <p><i class="fas fa-temperature-high"></i> ${temp}°C</p>
                <p><i class="fas fa-tint"></i> ${humidity}% Humidity</p>
                <p><i class="fas fa-cloud"></i> ${condition}</p>
            `;
        }

        // Utility function for API calls with token handling
        async function apiCall(url, options = {}) {
            if (!accessToken) {
                throw new Error('No access token available');
            }

            const headers = {
                'Authorization': `Bearer ${accessToken}`,
                'Content-Type': 'application/json',
                ...options.headers
            };

            try {
                const response = await fetch(url, { ...options, headers });

                if (response.status === 401) {
                    // Token expired, try to refresh
                    const refreshed = await refreshAccessToken();
                    if (refreshed) {
                        // Retry with new token
                        headers.Authorization = `Bearer ${accessToken}`;
                        const retryResponse = await fetch(url, { ...options, headers });
                        return await retryResponse.text();
                    }
                    throw new Error('Authentication failed');
                }

                if (!response.ok) {
                    throw new Error(`API call failed: ${response.status}`);
                }

                return await response.text();
            } catch (error) {
                throw error;
            }
        }

        // Initialize navigation
        function initializeNavigation() {
            const navLinks = document.querySelectorAll('.nav-link');
            const pages = document.querySelectorAll('.page');
            
            navLinks.forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    const targetPage = this.getAttribute('data-page');
                    
                    // Hide all pages
                    pages.forEach(page => {
                        page.classList.remove('active');
                    });
                    
                    // Show target page
                    document.getElementById(targetPage).classList.add('active');
                    
                    // Scroll to top
                    window.scrollTo(0, 0);
                });
            });
            
            // Mobile menu toggle
            const mobileMenuBtn = document.querySelector('.mobile-menu-btn');
            const navMenu = document.querySelector('.nav-menu');
            
            if (mobileMenuBtn && navMenu) {
                mobileMenuBtn.addEventListener('click', function() {
                    navMenu.classList.toggle('active');
                });
            }
        }

        // Initialize forms
        function initializeForms() {
            // Advisory form
            const advisoryForm = document.getElementById('advisory-form');
            if (advisoryForm) {
                advisoryForm.addEventListener('submit', handleSoilAnalysisForm);
            }

            // Weather form
            const weatherForm = document.getElementById('weather-form');
            if (weatherForm) {
                weatherForm.addEventListener('submit', handleWeatherForm);
            }

            // Chat form
            const chatForm = document.getElementById('chat-form');
            if (chatForm) {
                chatForm.addEventListener('submit', handleChatForm);
                chatSessionId = generateSessionId();
            }
        }

        // Generate session ID for chat
        function generateSessionId() {
            return 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }

        // Handle soil analysis form submission (from working second code)
        async function handleSoilAnalysisForm(e) {
            e.preventDefault();
            
            const submitBtn = document.getElementById('submit-btn');
            const resultDiv = document.getElementById('result');
            const adviceContent = document.getElementById('advice-content');
            
            // Get form data
            const cropType = document.getElementById('crop-type').value;
            const areaValue = parseFloat(document.getElementById('area-value').value);
            const areaUnit = document.getElementById('area-unit').value;
            const season = document.getElementById('season').value;
            const language = document.getElementById('language').value;
            const location = document.getElementById('location').value;
            const soilType = document.getElementById('soil-type-select').value;
            const soilImage = document.getElementById('soil-image').files[0];
            
            // Validate required fields
            if (!cropType || !areaValue || !areaUnit || !season || !language) {
                showError('Please fill all required fields marked with *');
                return;
            }
            
            // Show loading state
            submitBtn.innerHTML = '<span class="loading-spinner"></span>Processing with AI...';
            submitBtn.disabled = true;
            
            // Clear previous results
            resultDiv.style.display = 'none';
            adviceContent.innerHTML = '';
            
            // Show waiting message
            showWaitingMessage();
            
            try {
                // Prepare form data
                const formData = new FormData();
                formData.append('cropType', cropType);
                formData.append('areaValue', areaValue);
                formData.append('areaUnit', areaUnit);
                formData.append('season', season);
                formData.append('language', language);
                
                if (location && location.trim()) formData.append('location', location.trim());
                if (soilType && soilType.trim()) formData.append('soilType', soilType);
                if (soilImage) formData.append('soilImage', soilImage);
                
                console.log('Submitting form data to:', SOIL_ANALYSIS_URL);
                
                // Make API request with longer timeout
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 120000); // 2 minutes timeout
                
                const response = await fetch(SOIL_ANALYSIS_URL, {
                    method: 'POST',
                    body: formData,
                    signal: controller.signal
                });
                
                clearTimeout(timeoutId);
                console.log('Response status:', response.status);
                
                const responseText = await response.text();
                console.log('Response text:', responseText);
                
                if (response.ok) {
                    // Backend returns simple text message on success
                    // We need to call the AI service to get the actual recommendation
                    await getAIRecommendation({
                        cropType, areaValue, areaUnit, season, language,
                        location: location || null,
                        soilType: soilType || null,
                        hasImage: !!soilImage
                    }, responseText);
                } else {
                    // Handle error response
                    let errorMessage = responseText || 'Unknown error occurred';
                    
                    // Try to parse error if it's JSON
                    try {
                        const errorJson = JSON.parse(responseText);
                        errorMessage = errorJson.message || errorJson.error || errorMessage;
                    } catch (parseError) {
                        // Use raw text if not JSON
                    }
                    
                    showError(`Server Error (${response.status}): ${errorMessage}`);
                }
                
            } catch (error) {
                console.error('Network error:', error);
                
                let errorMessage;
                if (error.name === 'AbortError') {
                    errorMessage = 'Request timed out. The AI analysis is taking longer than expected. Please try again.';
                } else if (error.name === 'TypeError' && error.message.includes('fetch')) {
                    errorMessage = `Connection failed: Cannot reach the analysis service at ${SOIL_ANALYSIS_URL}. Please check:
                    
• Is the backend server running on port 8081?
• Is CORS properly configured on the server?
• Check browser console for detailed errors`;
                } else {
                    errorMessage = `Network error: ${error.message}`;
                }
                
                showError(errorMessage);
            } finally {
                // Restore button state
                submitBtn.innerHTML = 'Get AI Soil Analysis';
                submitBtn.disabled = false;
            }
        }

        // Get AI recommendation from fertilizer service
        async function getAIRecommendation(inputData, producerResponse) {
            try {
                // Call the fertilizer analysis endpoint
                const formData = new FormData();
                formData.append('cropType', inputData.cropType);
                formData.append('areaValue', inputData.areaValue);
                formData.append('areaUnit', inputData.areaUnit);
                formData.append('season', inputData.season);
                formData.append('language', inputData.language);
                
                if (inputData.location) formData.append('location', inputData.location);
                if (inputData.soilType) formData.append('soilType', inputData.soilType);
                
                // Add image if it was uploaded
                const soilImage = document.getElementById('soil-image').files[0];
                if (soilImage) formData.append('soilImage', soilImage);
                
                console.log('Getting AI recommendation from fertilizer service...');
                
                // Call fertilizer analysis service
                const fertilizerResponse = await fetch(FERTILIZER_ANALYSIS_URL, {
                    method: 'POST',
                    body: formData
                });
                
                if (fertilizerResponse.ok) {
                    const recommendation = await fertilizerResponse.json();
                    showAIRecommendation(recommendation, inputData, producerResponse);
                } else {
                    // If fertilizer service fails, show basic success
                    showBasicSuccess(inputData, producerResponse);
                }
                
            } catch (error) {
                console.error('Error getting AI recommendation:', error);
                // If AI service fails, show basic success
                showBasicSuccess(inputData, producerResponse);
            }
        }

        // Show waiting message while processing
        function showWaitingMessage() {
            const resultDiv = document.getElementById('result');
            const adviceContent = document.getElementById('advice-content');
            
            const waitingHtml = `
                <div class="waiting-message pulse-animation">
                    <div class="loading-spinner" style="display: inline-block; margin-right: 15px;"></div>
                    <h4><i class="fas fa-robot"></i> AI Analysis in Progress</h4>
                    <p>Our AI system is analyzing your soil and crop data. This may take 30-90 seconds...</p>
                    
                    <div class="processing-steps">
                        <div class="processing-step">
                            <i class="fas fa-microscope"></i>
                            <p style="margin: 0; font-size: 0.9em;">Analyzing Soil</p>
                        </div>
                        <div class="processing-step">
                            <i class="fas fa-seedling"></i>
                            <p style="margin: 0; font-size: 0.9em;">Crop Requirements</p>
                        </div>
                        <div class="processing-step">
                            <i class="fas fa-flask"></i>
                            <p style="margin: 0; font-size: 0.9em;">Fertilizer Matching</p>
                        </div>
                        <div class="processing-step">
                            <i class="fas fa-chart-line"></i>
                            <p style="margin: 0; font-size: 0.9em;">Recommendations</p>
                        </div>
                    </div>
                    
                    <p style="font-size: 0.9em; color: #666; margin-top: 15px;">
                        Please wait while our AI processes your request. The system is analyzing multiple factors to provide the most accurate recommendations.
                    </p>
                </div>
            `;
            
            adviceContent.innerHTML = waitingHtml;
            resultDiv.style.display = 'block';
            resultDiv.scrollIntoView({ behavior: 'smooth' });
        }

        // Show AI recommendation
        function showAIRecommendation(recommendation, inputData, producerResponse) {
            const resultDiv = document.getElementById('result');
            const adviceContent = document.getElementById('advice-content');
            
            const aiHtml = `
                <div class="success-message">
                    <h4><i class="fas fa-check-circle"></i> AI Soil Analysis Complete!</h4>
                    <p>Your personalized fertilizer recommendations are ready</p>
                </div>
                
                <div class="analysis-result">
                    <h4><i class="fas fa-seedling"></i> Soil Analysis Results</h4>
                    <div class="fertilizer-card">
                        <h6><i class="fas fa-microscope"></i> Detected Soil Type</h6>
                        <p>${recommendation.detectedSoilType}</p>
                    </div>
                    
                    <div class="fertilizer-card">
                        <h6><i class="fas fa-lightbulb"></i> General Recommendation</h6>
                        <p>${recommendation.generalRecommendation}</p>
                    </div>
                </div>

                <div class="analysis-result">
                    <h4><i class="fas fa-flask"></i> Fertilizer Recommendations</h4>
                    ${recommendation.fertilizers.map(fertilizer => `
                        <div class="fertilizer-card">
                            <h6>${fertilizer.name} (${fertilizer.npkRatio})</h6>
                            <p><strong>Company:</strong> ${fertilizer.company}</p>
                            <p><strong>Quantity:</strong> ${fertilizer.quantity}</p>
                            <p><strong>Application Method:</strong> ${fertilizer.applicationMethod}</p>
                        </div>
                    `).join('')}
                </div>

                <div class="analysis-result">
                    <div class="recommendation-section">
                        <h5><i class="fas fa-tips"></i> Application Tips</h5>
                        <ul>
                            ${recommendation.applicationTips.map(tip => `<li>${tip}</li>`).join('')}
                        </ul>
                    </div>
                </div>

                <div class="analysis-result">
                    <div class="recommendation-section">
                        <h5><i class="fas fa-calendar-alt"></i> Seasonal Advice</h5>
                        <ul>
                            ${recommendation.seasonalAdvice.map(advice => `<li>${advice}</li>`).join('')}
                        </ul>
                    </div>
                </div>

                <div class="analysis-result">
                    <div class="recommendation-section">
                        <h5><i class="fas fa-bug"></i> Pesticide Recommendations</h5>
                        <ul>
                            ${recommendation.pesticideRecommendation.map(pest => `<li>${pest}</li>`).join('')}
                        </ul>
                    </div>
                </div>

                <div class="analysis-result">
                    <h4><i class="fas fa-info-circle"></i> Your Request Details</h4>
                    <div style="background: white; padding: 15px; border-radius: 8px;">
                        <p><strong>Crop:</strong> ${inputData.cropType}</p>
                        <p><strong>Area:</strong> ${inputData.areaValue} ${inputData.areaUnit.toLowerCase()}</p>
                        <p><strong>Season:</strong> ${inputData.season}</p>
                        <p><strong>Language:</strong> ${inputData.language}</p>
                        <p><strong>Location:</strong> ${inputData.location || 'Not provided'}</p>
                        <p><strong>Soil Type:</strong> ${inputData.soilType || 'Detected by AI'}</p>
                        <p><strong>Image Analysis:</strong> ${inputData.hasImage ? 'Yes' : 'No'}</p>
                    </div>
                </div>
            `;
            
            adviceContent.innerHTML = aiHtml;
            resultDiv.style.display = 'block';
            resultDiv.scrollIntoView({ behavior: 'smooth' });
        }

        // Show basic success if AI service fails
        function showBasicSuccess(inputData, producerResponse) {
            const resultDiv = document.getElementById('result');
            const adviceContent = document.getElementById('advice-content');
            
            const basicHtml = `
                <div class="success-message">
                    <h4><i class="fas fa-check-circle"></i> Request Processed Successfully!</h4>
                    <p>Your soil analysis request has been submitted to our AI system.</p>
                </div>
                
                <div class="analysis-result">
                    <h4><i class="fas fa-seedling"></i> Your Request Details</h4>
                    <div style="background: white; padding: 15px; border-radius: 8px;">
                        <p><strong>Crop:</strong> ${inputData.cropType}</p>
                        <p><strong>Area:</strong> ${inputData.areaValue} ${inputData.areaUnit.toLowerCase()}</p>
                        <p><strong>Season:</strong> ${inputData.season}</p>
                        <p><strong>Language:</strong> ${inputData.language}</p>
                        <p><strong>Location:</strong> ${inputData.location || 'Not provided'}</p>
                        <p><strong>Soil Type:</strong> ${inputData.soilType || 'To be detected by AI'}</p>
                        <p><strong>Image Provided:</strong> ${inputData.hasImage ? 'Yes' : 'No'}</p>
                    </div>
                    
                    <div style="background: #e8f5e8; padding: 15px; border-radius: 8px; margin: 15px 0;">
                        <h5><i class="fas fa-server"></i> Server Response:</h5>
                        <p style="font-family: monospace; background: white; padding: 10px; border-radius: 5px; margin-top: 10px;">${producerResponse}</p>
                    </div>
                    
                    <div style="background: #fff3cd; padding: 15px; border-radius: 8px; border-left: 4px solid #ffc107; margin-top: 15px;">
                        <p><strong><i class="fas fa-info-circle"></i> Processing Status:</strong></p>
                        <p>Your request has been successfully submitted to our AI analysis system. The system will process your data in the background and generate detailed fertilizer recommendations based on:</p>
                        <ul style="margin: 10px 0; padding-left: 20px;">
                            <li>Crop type and growing season</li>
                            <li>Farm area and soil conditions</li>
                            <li>Regional farming practices</li>
                            <li>Image analysis (if provided)</li>
                        </ul>
                        <p>For immediate assistance, you can also use our agriculture chatbot for quick farming tips and general guidance.</p>
                    </div>
                </div>
            `;
            
            adviceContent.innerHTML = basicHtml;
            resultDiv.style.display = 'block';
            resultDiv.scrollIntoView({ behavior: 'smooth' });
        }
        
        // Show error message
        function showError(errorMessage) {
            const resultDiv = document.getElementById('result');
            const adviceContent = document.getElementById('advice-content');
            
            const errorHtml = `
                <div class="error-message">
                    <h4><i class="fas fa-exclamation-triangle"></i> Connection Error</h4>
                    <pre style="white-space: pre-line; font-family: inherit;">${errorMessage}</pre>
                </div>
                
                <div style="background: #e3f2fd; padding: 15px; border-radius: 8px; border-left: 4px solid #2196f3; margin-top: 15px;">
                    <h5><i class="fas fa-tools"></i> Troubleshooting Steps:</h5>
                    <ol style="margin: 10px 0; padding-left: 20px;">
                        <li><strong>Backend Server:</strong> Ensure your backend server is running on port 8081</li>
                        <li><strong>CORS Configuration:</strong> Add the following CORS configuration to your backend:
                            <pre style="background: #f5f5f5; padding: 10px; margin: 5px 0; border-radius: 5px; font-size: 0.9em;">@CrossOrigin(origins = {"http://localhost:3000", "http://127.0.0.1:5500", "*"})
@RestController
public class KafkaProducer {
    // Your existing code
}</pre>
                        </li>
                        <li><strong>Check URL:</strong> Verify the backend URL is correct: <code>http://localhost:8081/api/producer/soil-analysis-form</code></li>
                        <li><strong>Browser Console:</strong> Check browser developer tools (F12) for detailed error messages</li>
                        <li><strong>Network Tab:</strong> Check if the request is being sent and what response is received</li>
                    </ol>
                </div>
                
                <div style="background: #f0f7f0; padding: 15px; border-radius: 8px; margin-top: 15px;">
                    <h5><i class="fas fa-lightbulb"></i> Alternative Testing:</h5>
                    <p>You can test your backend directly using:</p>
                    <ul style="margin: 10px 0; padding-left: 20px;">
                        <li><strong>Postman:</strong> Send POST request to the endpoint with form-data</li>
                        <li><strong>cURL:</strong> Test from command line</li>
                        <li><strong>Browser:</strong> Navigate to <a href="http://localhost:8081/api/producer" target="_blank">http://localhost:8081/api/producer</a> to check if server is running</li>
                    </ul>
                </div>
            `;
            
            adviceContent.innerHTML = errorHtml;
            resultDiv.style.display = 'block';
            resultDiv.scrollIntoView({ behavior: 'smooth' });
        }

        // Handle chatbot form submission
        async function handleChatForm(e) {
            e.preventDefault();
            
            const messageInput = document.getElementById('chat-input');
            const imageInput = document.getElementById('chat-image');
            const message = messageInput.value.trim();
            const image = imageInput.files[0];
            
            if (!message && !image) {
                alert('Please enter a message or upload an image');
                return;
            }
            
            // Add user message to chat
            addChatMessage(message, true, image);
            
            // Clear inputs
            messageInput.value = '';
            imageInput.value = '';
            
            // Show typing indicator
            showTypingIndicator();
            
            try {
                const formData = new FormData();
                formData.append('message', message || 'Please analyze this image');
                formData.append('sessionId', chatSessionId);
                if (image) formData.append('image', image);
                
                const response = await fetch(CHATBOT_URL, {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                
                hideTypingIndicator();
                
                if (data.success) {
                    addChatMessage(data.message, false);
                } else {
                    addChatMessage('Sorry, I had trouble processing your request. Please try again with a farming-related question.', false);
                }
                
            } catch (error) {
                console.error('Chatbot error:', error);
                hideTypingIndicator();
                addChatMessage('Connection error. Please check your internet connection and try again.', false);
            }
        }
        
        // Add message to chat
        function addChatMessage(message, isUser, image = null) {
            const chatMessages = document.getElementById('chat-messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `chat-message ${isUser ? 'user-message' : 'bot-message'}`;
            
            let imageHtml = '';
            if (image && isUser) {
                const imageUrl = URL.createObjectURL(image);
                imageHtml = `<div style="margin-bottom: 8px;"><img src="${imageUrl}" alt="Uploaded image" style="max-width: 200px; max-height: 150px; border-radius: 8px;"></div>`;
            }
            
            const icon = isUser ? '<i class="fas fa-user" style="color: white; margin-right: 8px;"></i>' : 
                                '<i class="fas fa-robot" style="color: var(--primary); margin-right: 8px;"></i>';
            
            messageDiv.innerHTML = `
                <div class="message-content">
                    ${imageHtml}
                    ${icon}${message}
                </div>
            `;
            
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
        
        // Show typing indicator
        function showTypingIndicator() {
            const chatMessages = document.getElementById('chat-messages');
            const typingDiv = document.createElement('div');
            typingDiv.className = 'typing-indicator';
            typingDiv.id = 'typing-indicator';
            typingDiv.innerHTML = '<i class="fas fa-robot" style="color: var(--primary); margin-right: 8px;"></i>AI Assistant is thinking<span class="typing-dots"></span>';
            
            chatMessages.appendChild(typingDiv);
            typingDiv.style.display = 'block';
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
        
        // Hide typing indicator
        function hideTypingIndicator() {
            const typingIndicator = document.getElementById('typing-indicator');
            if (typingIndicator) {
                typingIndicator.remove();
            }
        }

        function handleWeatherForm(e) {
            e.preventDefault();
            const city = document.getElementById('weather-city').value.trim();
            
            if (!city) {
                alert('Please enter a city name');
                return;
            }
            
            getWeatherForCity(city);
        }

        // Initialize weather widget
        function initializeWeatherWidget() {
            // Check if user has stored city and load weather immediately
            const storedCity = localStorage.getItem('userCity');
            if (storedCity && !accessToken) {
                // Load weather for stored city even before login
                userCity = storedCity;
                fetchCityWeatherForSignup(storedCity);
            }
            
            // Update weather every 10 minutes
            setInterval(() => {
                if (accessToken && currentUser) {
                    if (userCity) {
                        loadUserCityWeather();
                    } else {
                        loadUserWeather();
                    }
                }
            }, 600000);
        }

        // Global functions for form interactions
        window.showLoginForm = showLoginForm;
        window.showSignupForm = showSignupForm;
        window.signup = signup;
        window.sendOtp = sendOtp;
        window.verifyOtp = verifyOtp;
        window.resendOtp = resendOtp;
        window.logout = logout;
    </script>
</body>
</html>